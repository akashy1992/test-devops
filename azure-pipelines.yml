# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: ubuntu-latest

- stage: DeployAKSClusters
  jobs:
    - deployment: DeployDevAKSCluster
      displayName: DeployDevAKSCluster
      pool:
        vmImage: 'ubuntu-latest'
      environment: $(DEV_ENVIRONMENT)      
      strategy:
        runOnce:
          deploy:
            steps:
            - task: TerraformCLI@0
              displayName: Terraform Init
              inputs:
                command: 'init'
                workingDirectory: '$(Pipeline.Workspace)'
            - task: TerraformCLI@0
              displayName: Terraform Plan
              inputs:
                command: 'plan'
                workingDirectory: '$(Pipeline.Workspace)'
            - task: TerraformCLI@0
              displayName: Terraform Apply
              inputs:
                command: 'apply'
                workingDirectory: '$(Pipeline.Workspace)'
            - task: TerraformCLI@0
              displayName: 'terraform output'
              inputs:
                  command: output
            - script: echo $(System.AccessToken) | az devops login
              env:
                AZURE_DEVOPS_CLI_PAT: $(System.AccessToken)
              displayName: 'Login Azure DevOps Extension'
            - bash |
               echo 'some_string is $(TF_OUT_quickmail_resource_group)'        
               echo 'some_sensitive_string is $(TF_OUT_quickmail_resource_group_2)'
            - script: az devops configure --defaults organization=https://dev.azure.com/strategycompass project="QuickMail" --use-git-aliases true
              displayName: 'Set default Azure DevOps organization and project'
            - bash: |
                 az pipelines variable-group variable update --group-id 2 --name pass value $(TF_OUT_quickmail_resource_group_2) --secret false --organization https://dev.azure.com/akashyadav1992 --project "AzureAutomation"
              displayName: 'Update Variable Group'
